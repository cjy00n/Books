# 실행 컨텍스트의 생성과 식별자 검색 과정

```jsx
// 예제 23-04
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }
  bar(10);
}

foo(20); // 42
```

1. 전역 객체 생성
   1. 전역 객체에는 빌트인 전역 프로퍼티와 빌트인 전역 함수, 그리고 표준 빌트인 객체가 추가되며 동작 환경(클라이언트 사이드 또는 서버 사이드)에 따라 클라이언트 사이드 Web API 또는 특정 환경을 위한 호스트 객체를 포함한다.
   2. 전역 객체도 Object.prototype을 상속받는다. 즉, 전역 객체도 프로토타입 체인의 일원이다.
2. 전역 코드 평가

   1. 전역 실행 컨텍스트 생성
   2. 전역 렉시컬 환경 생성
      1. 전역 환경 레코드 생성
         1. 객체 환경 레코드 생성
         2. 선언적 환경 레코드 생성
   3. this 바인딩
   4. 외부 렉시컬 환경에 대한 참조 결정

   <div align="center"><img src="https://blog.kakaocdn.net/dn/bkDB1q/btrxyiAVs4c/ue3xIpo1X18uWkNFaDGTbk/img.png"></div>

3. 전역 코드 실행
   1. 전역 코드가 순차적으로 실행되기 시작한다.
   2. 변수 할당문이 실행되어 변수에 값이 할당된다.
   3. 변수 할당문 또는 함수 호출문을 실행하려면 먼저 변수 또는 함수 이름이 선언된 식별자인지 확인해야 한다.
   4. **식별자 결정** : 어느 스코프의 식별자를 참조하면 되는지 결정한다.
   5. **식별자 결정을 위해 식별자를 검색할 때는 실행 중인 실행 컨텍스트에서 식별자를 검색하기 시작한다.**
4. foo 함수 코드 평가
   1. 함수 실행 컨텍스트 생성
   2. 함수 렉시컬 환경 생성
      1. 함수 환경 레코드 생성
      2. this 바인딩
      3. 외부 렉시컬 환경에 대한 참조 결정
5. foo 함수 코드 실행
   1. 런타임이 시작되어 foo 함수의 소스코드가 순차적으로 실행되기 시작한다.
   2. 매개변수에 인수가 할당되고, 변수 할당문이 실행되어 지역 변수 x,y에 값이 할당되고 함수 bar가 호출된다.
   3. **식별자 결정을 위해 실행 중인 실행 컨텍스트의 렉시컬 환경에서 식별자를 검색하기 시작한다.**
   4. 검색된 식별자에 값을 바인딩한다.
6. bar 함수 코드 평가
   1. bar 함수 내부로 코드의 제어권이 이동하고 bar 함수 코드를 평가하기 시작한다.
   2. 실행 컨텍스트와 렉시컬 환경의 생성 과정은 foo 함수 코드 평가와 동일하다.
7. bar 함수 코드 실행
   1. 런타임이 시작되어 bar 함수의 소스코드가 순차적으로 실행되기 시작한다.
   2. 매개변수에 인수가 할당되고, 변수 할당문이 실행되어 지역 변수 z에 값이 할당된다.
8. bar 함수 코드 실행 종료
   1. console.log 메서드가 호출되고 종료하면 더는 실행할 코드가 없으므로 bar 함수 코드의 실행이 종료된다.
   2. 실행 컨텍스트 스택에서 bar 함수 실행 컨텍스트가 팝되어 제거되고 foo 실행 컨텍스트가 실행 중인 실행 컨텍스트가 된다.
9. foo 함수 코드 실행 종료
   1. bar 함수가 종료하면 더 이상 실행할 코드가 없으므로 foo 함수 코드의 실행이 종료된다.
   2. 이때 실행 컨텍스트 스택에서 foo 함수 실행 컨텍스트가 팝되어 제거되고 전역 실행 컨텍스트가 실행 중인 실행 컨텍스트가 된다.
10. 전역 코드 실행 종료
    1. foo 함수가 종료되면 더는 실행할 전역 코드가 없으므로 전역 코드의 실행이 종료되고 전역 실행 컨텍스트도 실행 컨텍스트 스택에서 팝되어 제거되고 실행 컨텍스트 스택에는 아무것도 남아있지 않게 된다.

# 실행 컨텍스트와 블록 레벨 스코프

`var` 키워드로 선언한 변수는 오로지 함수의 코드 블록만 지역 스코프로 인정하는 함수 레벨 스코프를 따른다.

하지만, `let`, `const` 키워드로 선언한 변수는 모든 코드 블록(함수, if문, while문, try/catch문 등)을 지역 스코프로 인정하는 블록 레벨 스코프를 따른다.

```jsx
// 예제 23-05

let x = 1;

if (true) {
  let x = 10;
  console.log(x); // 10
}

console.log(x); // 1
```

- 위의 예제에서 if 문의 코드 블록이 실행되면 if문의 코드 블록을 위한 블록 레벨 스코프를 생성해야 한다.
- 이를 위해 선언적 환경 레코드를 갖는 렉시컬 환경을 새롭게 생성하여 기존의 전역 렉시컬 환경을 교체한다.
- 이때 새롭게 생성된 if문의 코드 블록을 위한 렉시컬 환경의 외부 렉시컬 환경에 대한 참조는 if문이 실행되기 이전의 전역 렉시컬 환경을 가리킨다.

- 이는 if문 뿐 아니라, 블록 레벨 스코프를 생성하는 모든 블록문에 적용된다.
